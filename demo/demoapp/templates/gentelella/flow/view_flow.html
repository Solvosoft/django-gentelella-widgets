{% extends 'gentelella/base.html' %}
{% load gtsettings timejs %}

{% block content %}
<div class="container mt-5">
    <div class="progress">
        <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 100%;" aria-valuenow="10" aria-valuemin="0" aria-valuemax="100">
            Not Steps
        </div>
    </div>
</div>
			<div class="container my-5">
    <div class="card shadow-sm">
        <div class="card-header text-center">
									<div id="tittle_content"></div>
        </div>
        <div class="card-body">

            <div id="step_content" class="text-center">
            </div>
												<div id="gt_db_form_formset" style="display: none;">
												</div>
												<div id="gt_db_field_form" style="display: none;">
												</div>
        </div>
        <div class="card-footer d-flex justify-content-between">
            <button id="previous-button" class="btn btn-secondary" style="display: none;">Back</button>
            <button id="next-button" class="btn btn-primary ms-auto">Next</button>
        </div>
    </div>
</div>


{% endblock %}

{% block js %}

  <script>

    const flowData = JSON.parse('{{ data|safe }}');
    console.log(flowData);

    let currentStepIndex = 0;

    document.getElementById("tittle_content").innerHTML = `
        <h2>${flowData.flow.name || "This flow does not exist"}</h2>
        <p>${flowData.flow.description || "No description available for this flow."}</p>`;

    function displayStep(i) {
        const step = flowData.steps[i];
        if (step) {
            let formHtml = `
                <h3 class="my-3">${step.name}</h3>
                <h3 class="my-3">${step.order}</h3>
                <p>${step.description || "No description available for this step."}</p>`;

            const formFormsetElement = document.getElementById("gt_db_form_formset");
            const fieldFormElement = document.getElementById("gt_db_field_form");

            if (formFormsetElement && fieldFormElement) {
																	formHtml += `<div id="gtDbFormFormsetContainer">`;

																	step.forms_with_fields.forEach(formWithFields => {
																					formHtml += `
																									<div class="form-container">
																													<h4>Form: ${formWithFields.token || "Form not available"}</h4>`;

																					formWithFields.fields.forEach(field => {
																									formHtml += `
																													<div class="form-group">
																																	<label for="field_${field.id}">${field.label}</label>
																																	<input type="text" id="field_${field.id}" name="field_${field.name}" class="form-control" required="${field.required}">
																													</div>`;
																					});

																					formHtml += `</div>`;
																	});

																	formHtml += `</div>`;
            }

            document.getElementById("step_content").innerHTML = formHtml;
            updateProgressBar(i);
            updateNavigationButtons(i);
        }
    }

    function updateProgressBar(i) {
        const totalSteps = flowData.steps.length;
        const progressPercentage = ((i + 1) / totalSteps) * 100;
        const progressBar = document.getElementById("progress-bar");

        progressBar.style.width = `${progressPercentage}%`;
        progressBar.setAttribute('aria-valuenow', progressPercentage);
        progressBar.innerText = `Step ${i + 1} of ${totalSteps}`;
    }

    function getNextStepIndex(currentIndex) {
        return currentIndex + 1 < flowData.steps.length ? currentIndex + 1 : currentIndex;
    }

    function getPreviousStepIndex(currentIndex) {
        return currentIndex > 0 ? currentIndex - 1 : 0;
    }

    function updateNavigationButtons(i) {
        const nextButton = document.getElementById("next-button");
        const previousButton = document.getElementById("previous-button");

        previousButton.style.display = i > 0 ? "inline-block" : "none";

        if (i === flowData.steps.length - 1) {
            nextButton.innerText = "Finish";
        } else {
            nextButton.innerText = "Next";
        }
    }

    document.getElementById("next-button").addEventListener("click", () => {
        const nextIndex = getNextStepIndex(currentStepIndex);
        if (nextIndex !== currentStepIndex) {
            currentStepIndex = nextIndex;
            displayStep(currentStepIndex);
        }
    });

    document.getElementById("previous-button").addEventListener("click", () => {
        const previousIndex = getPreviousStepIndex(currentStepIndex);
        if (previousIndex !== currentStepIndex) {
            currentStepIndex = previousIndex;
            displayStep(currentStepIndex);
        }
    });

    displayStep(currentStepIndex);
		</script>

{% endblock js%}
